<!doctype html>
<html lang="ru" dir="ltr">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title data-translate="page_title">
            Панель пользователя | {{ user.username }}
        </title>
        <meta name="theme-color" content="#000000" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <link
            href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-Digits/font-face.css"
            rel="stylesheet"
            type="text/css"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
            rel="stylesheet"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
        <style>
            /* * ==============================================
         * GLOBAL THEME VARIABLES (Red/Black Cyberpunk)
         * ==============================================
         */
            :root {
                /* Фоновые цвета: Глубокий баклажан/фиолетовый */
                --bg-body: #0d0b14;
                --bg-card: #161420;
                --bg-card-hover: #1f1c2c;

                /* Основной акцент: Янтарно-золотой */
                --primary: #f59e0b;
                --primary-dark: #d97706;
                --primary-glow: rgba(245, 158, 11, 0.3);
                --primary-dim: rgba(245, 158, 11, 0.07);

                /* Типографика */
                --text-main: #f1f1f1;
                --text-muted: #9a93ad;
                --text-dark: #5b556e;

                /* Статусы */
                --status-active: #10b981;
                --status-warning: #f59e0b;
                --status-danger: #f43f5e;
                --status-disabled: #4b4855;

                /* Границы и радиусы */
                --radius-sm: 10px;
                --radius-md: 18px;
                --radius-lg: 28px;
                --radius-full: 9999px;
                --border-light: 1px solid rgba(154, 147, 173, 0.1);
                --border-primary: 1px solid rgba(245, 158, 11, 0.25);
                --font-stack: "Arad", "Vazirmatn", sans-serif;
            }

            /* Светлая тема: "Soft Ivory" (Слоновая кость и золото) */
            body.light-theme {
                --bg-body: #fdfcf9;
                --bg-card: #ffffff;
                --bg-card-hover: #f7f5f0;

                --primary: #b45309;
                --primary-dark: #92400e;
                --primary-glow: rgba(180, 83, 9, 0.15);
                --primary-dim: rgba(180, 83, 9, 0.05);

                --text-main: #2d2a26;
                --text-muted: #716b64;
                --text-dark: #c1bcb3;

                --border-light: 1px solid rgba(45, 42, 38, 0.08);
                --border-primary: 1px solid rgba(180, 83, 9, 0.2);

                --status-active: #065f46;
                --status-warning: #92400e;
                --status-danger: #9f1239;
                --status-disabled: #8d8d8d;
            }

            /* تنظیم فونت بر اساس زبان */
            body.lang-en,
            body.lang-ru {
                --font-stack: "Roboto", sans-serif;
                font-family: var(--font-stack) !important;
            }
            body.lang-ar {
                --font-stack: "Vazirmatn", sans-serif;
                font-family: var(--font-stack) !important;
            }

            /* * ==============================================
         * RESET & BASIC LAYOUT
         * ==============================================
         */
            * {
                box-sizing: border-box;
                outline: none;
                -webkit-tap-highlight-color: transparent;
            }
            body {
                margin: 0;
                padding: 0;
                min-height: 100vh;
                font-family: var(--font-stack);
                background-color: var(--bg-body);
                color: var(--text-main);
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px;
                overflow-x: hidden;
                transition:
                    background-color 0.3s ease,
                    color 0.3s ease;
            }

            /* پس‌زمینه ثابت */
            .bg-fixed {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -2;
                background: radial-gradient(
                    circle at top center,
                    #1a0508 0%,
                    #000000 70%
                );
                pointer-events: none;
                transition: background 0.3s ease;
            }
            body.light-theme .bg-fixed {
                /* پس زمینه تمیزتر برای تم روشن */
                background: radial-gradient(
                    circle at top center,
                    #ffebee 0%,
                    #f0f2f5 80%
                );
            }

            /* نقاط نورانی متحرک */
            .bg-spot {
                position: fixed;
                border-radius: 50%;
                filter: blur(90px);
                opacity: 0.25;
                z-index: -1;
                animation: pulseGlow 10s infinite alternate;
            }
            .spot-1 {
                top: -10%;
                left: -10%;
                width: 50vw;
                height: 50vw;
                background: var(--primary);
            }
            .spot-2 {
                bottom: -10%;
                right: -10%;
                width: 60vw;
                height: 60vw;
                background: #600010;
                animation-delay: 2s;
            }
            body.light-theme .spot-2 {
                background: #ffcdd2;
                opacity: 0.4;
            }

            @keyframes pulseGlow {
                0% {
                    transform: scale(1);
                    opacity: 0.2;
                }
                100% {
                    transform: scale(1.1);
                    opacity: 0.3;
                }
            }

            /* کانتینر اصلی */
            .main-wrapper {
                width: 100%;
                max-width: 500px;
                position: relative;
                z-index: 1;
                padding-bottom: 60px; /* فضای کمتر برای فوتر */
            }

            /* تنظیمات (زبان و تم) */
            .settings-bar {
                display: flex;
                justify-content: space-between; /* پخش شدن در عرض */
                align-items: center;
                margin-bottom: 20px;
                width: 100%;
            }
            .icon-btn {
                background: rgba(255, 255, 255, 0.05);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: var(--text-main);
                width: 42px;
                height: 42px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: 0.2s;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
            .icon-btn:hover {
                border-color: var(--primary);
                color: var(--primary);
                transform: translateY(-2px);
            }
            body.light-theme .icon-btn {
                background: rgba(255, 255, 255, 0.6);
                border-color: rgba(0, 0, 0, 0.05);
            }

            .lang-select-wrapper {
                position: relative;
                display: flex;
                align-items: center;
            }
            /* استایل لیکوئید گلس (Liquid Glass) برای انتخاب زبان - آپدیت شده */
            .lang-select {
                appearance: none;
                -webkit-appearance: none;
                /* تغییر برای افکت شیشه‌ای قوی‌تر و زیباتر */
                background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.1),
                    rgba(255, 255, 255, 0.05)
                );
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
                border: 1px solid rgba(255, 255, 255, 0.18);
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
                color: var(--text-main);
                padding: 0 15px;
                padding-right: 35px; /* فضا برای فلش سفارشی */
                height: 42px;
                border-radius: 12px;
                font-family: inherit;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 500;
                transition: all 0.3s ease;
                text-align: center;
                direction: ltr; /* برای نمایش صحیح */
                width: auto;
                min-width: 140px;
            }
            /* آیکون فلش برای سلکت */
            .lang-select-wrapper::after {
                content: "▼";
                font-size: 0.7rem;
                color: var(--text-muted);
                position: absolute;
                right: 12px;
                pointer-events: none;
                transition: 0.3s;
            }
            /* اصلاح فلش در حالت RTL */
            [dir="rtl"] .lang-select {
                padding-right: 15px;
                padding-left: 35px;
            }
            [dir="rtl"] .lang-select-wrapper::after {
                right: auto;
                left: 12px;
            }

            .lang-select:hover,
            .lang-select:focus {
                border-color: var(--primary);
                background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.15),
                    rgba(255, 255, 255, 0.08)
                );
                transform: translateY(-1px);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            }
            body.light-theme .lang-select {
                background: rgba(255, 255, 255, 0.7);
                border-color: rgba(255, 255, 255, 0.4);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
                color: #333;
            }
            body.light-theme .lang-select:hover {
                background: rgba(255, 255, 255, 0.9);
            }
            .lang-select option {
                background: var(--bg-card);
                color: var(--text-main);
                padding: 10px;
            }
            body.light-theme .lang-select option {
                background: #fff;
                color: #333;
            }

            /* * ==============================================
         * PROFILE HEADER
         * ==============================================
         */
            .profile-card {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 30px;
                animation: slideDown 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            }
            .avatar-container {
                width: 90px;
                height: 90px;
                border-radius: 50%;
                background: #111;
                border: 2px solid var(--primary);
                box-shadow: 0 0 30px var(--primary-glow);
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 15px;
                position: relative;
            }
            .avatar-container svg {
                width: 45px;
                height: 45px;
                fill: #fff;
            }
            body.light-theme .avatar-container svg {
                fill: #f0f0f0;
            } /* آواتار روشن در تم روشن */
            body.light-theme .avatar-container {
                background: var(--primary);
                border-color: #fff;
            }

            .username-title {
                font-size: 1.5rem;
                font-weight: 800;
                margin: 0;
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
                color: var(--text-main);
            }
            body.light-theme .username-title {
                text-shadow: none;
                color: #000;
            }

            /* بج‌های وضعیت - اصلاح باگ رنگ در تم سفید */
            .status-chip {
                margin-top: 10px;
                padding: 6px 18px;
                border-radius: 50px;
                font-size: 0.8rem;
                font-weight: bold;
                background: rgba(20, 20, 20, 0.8);
                border: 1px solid rgba(255, 255, 255, 0.1);
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
            /* تنظیمات پایه چیپ در تم روشن */
            body.light-theme .status-chip {
                background: #fff;
                border-color: #e0e0e0;
                /* نکته مهم: رنگ متن را اینجا ست نمیکنیم تا کلاس‌های زیر اعمال شوند */
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }
            .dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: currentColor;
            }

            /* اعمال رنگ‌ها با اولویت بالا (Important برای جلوگیری از باگ رنگ مشکی) */
            .st-active {
                color: var(--status-active) !important;
                border-color: rgba(0, 255, 136, 0.3);
            }
            .st-expired {
                color: var(--status-danger) !important;
                border-color: rgba(255, 0, 60, 0.3);
            }
            .st-limited {
                color: var(--status-warning) !important;
                border-color: rgba(255, 170, 0, 0.3);
            }
            .st-disabled {
                color: var(--status-disabled) !important;
                border-color: #444;
            }

            /* سایه مخصوص برای وضعیت فعال */
            .st-active {
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.1);
            }

            /* * ==============================================
         * SUBSCRIPTION ACTIONS (COPY/QR)
         * ==============================================
         */
            .sub-actions {
                display: flex;
                align-items: center;
                gap: 10px;
                justify-content: center; /* center action buttons horizontally */
                flex-wrap: wrap; /* allow wrapping on narrow screens */
                margin-bottom: 10x;
                animation: fadeIn 0.8s ease 0.2s backwards;
            }
            .btn-main {
                background: var(--primary-dim);
                border: 1px solid var(--primary);
                color: var(--text-main);
                padding: 10px 14px;
                border-radius: var(--radius-md);
                font-family: inherit;
                font-weight: bold;
                font-size: 0.9rem;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.2s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                height: 52px;
            }
            /* Icon-only button (square, minimal) */
            .icon-btn {
                padding: 6px;
                width: 40px;
                height: 52px;
                min-width: 40px;
                border-radius: 10px;
                align-items: center;
                justify-content: center;
            }
            .btn-main:hover {
                background: var(--primary);
                color: #fff;
                box-shadow: 0 0 25px var(--primary-glow);
                transform: translateY(-2px);
            }
            body.light-theme .btn-main:hover {
                color: #fff;
            }
            .btn-main:active {
                transform: scale(0.97);
            }

            .btn-icon {
                width: 20px;
                height: 20px;
                fill: currentColor;
            }

            /* Platform Selector Header */
            .platform-selector-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                width: 100%;
                gap: 15px;
                margin-bottom: 0px;
            }
            .platform-selector-box {
                margin-bottom: 50px;
            }

            .platform-selector-header .section-header {
                flex: 1;
                margin-bottom: 0;
            }

            /* Platform Selector */
            .platform-selector-container {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 0;
                width: 100%;
            }
            .platform-dropdown-wrapper {
                position: relative;
            }
            .platform-dropdown-btn {
                background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.08),
                    rgba(255, 255, 255, 0.04)
                );
                backdrop-filter: blur(10px);
                border: 1px solid var(--primary);
                color: var(--text-main);
                padding: 6px 12px;
                border-radius: 8px;
                font-weight: 500;
                font-size: 0.85rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                transition: all 0.2s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                margin-top: 14px;
            }
            .platform-dropdown-btn:hover {
                background: linear-gradient(
                    135deg,
                    rgba(255, 0, 60, 0.15),
                    rgba(255, 0, 60, 0.08)
                );
                box-shadow: 0 0 20px var(--primary-glow);
            }
            .platform-dropdown-menu {
                position: absolute;
                top: 100%;
                right: 0;
                background: var(--bg-card);
                backdrop-filter: blur(16px);
                border: 1px solid var(--primary);
                border-radius: 10px;
                margin-top: 8px;
                min-width: 140px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                display: none;
                flex-direction: column;
                z-index: 100;
                overflow: hidden;
            }
            .platform-dropdown-menu.show {
                display: flex;
            }
            .platform-option {
                background: none;
                border: none;
                color: var(--text-main);
                padding: 12px 16px;
                text-align: left;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s ease;
                font-weight: 500;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }
            .platform-option:last-child {
                border-bottom: none;
            }
            .platform-option:hover {
                background: rgba(255, 0, 60, 0.15);
                color: var(--primary);
            }
            .platform-option.active {
                background: rgba(255, 0, 60, 0.25);
                color: var(--primary);
            }

            /* Download Application Buttons */
            .instruction-buttons {
                display: flex;
                flex-direction: column;
                gap: 15px;
                margin-bottom: 0;
                width: 100%;
                align-items: center;
            }
            .platform-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                justify-items: center;
                width: 100%;
            }
            .app-download-btn {
                background: linear-gradient(
                    135deg,
                    var(--primary-dim),
                    rgba(255, 0, 60, 0.05)
                );
                border: 1px solid var(--primary);
                color: var(--text-main);
                padding: 12px 16px;
                border-radius: 10px;
                text-decoration: none;
                text-align: center;
                font-weight: 500;
                font-size: 0.9rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                width: 100%;
                max-width: 200px;
            }
            .app-download-btn:hover {
                background: var(--primary);
                color: #fff;
                box-shadow: 0 0 25px var(--primary-glow);
                transform: translateY(-2px);
            }
            body.light-theme .app-download-btn {
                background: linear-gradient(
                    135deg,
                    rgba(255, 0, 60, 0.1),
                    rgba(255, 0, 60, 0.05)
                );
            }
            body.light-theme .app-download-btn:hover {
                color: #fff;
            }

            /* Slightly wider primary add button inside .sub-actions to stand out */
            .sub-actions > .btn-main:first-child {
                min-width: 220px; /* a bit wider */
                padding: 16px 24px;
                font-size: 1.05rem;
                justify-content: center;
            }

            @media (max-width: 420px) {
                .sub-actions > .btn-main:first-child {
                    min-width: 160px;
                    padding: 14px 20px;
                }

                .platform-selector-header {
                    flex-wrap: wrap;
                }

                .platform-selector-header .section-header {
                    width: 100%;
                }

                .platform-dropdown-btn {
                    padding: 6px 10px;
                    font-size: 0.8rem;
                }

                .platform-buttons {
                    grid-template-columns: 1fr;
                }

                .app-download-btn {
                    max-width: 100%;
                }

                .platform-dropdown-menu {
                    position: fixed;
                    top: auto;
                    right: auto;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 90%;
                    min-width: auto;
                    max-width: 280px;
                }
            }

            /* * ==============================================
         * STATS DASHBOARD
         * ==============================================
         */
            .dashboard-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin-bottom: 35px;
            }
            .stat-box {
                background: rgba(20, 20, 20, 0.6);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: var(--radius-md);
                padding: 20px;
                position: relative;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                transition: background 0.3s;
            }
            body.light-theme .stat-box {
                background: rgba(255, 255, 255, 0.9);
                border-color: rgba(0, 0, 0, 0.05);
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            }
            .stat-box::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 3px;
                background: linear-gradient(
                    90deg,
                    transparent,
                    var(--primary),
                    transparent
                );
                opacity: 0.6;
            }
            .stat-number {
                font-size: 1.4rem;
                font-weight: 800;
                margin: 10px 0 5px;
                color: var(--text-main);
            }
            .stat-desc {
                font-size: 0.75rem;
                color: var(--text-muted);
            }

            .progress-bar-bg {
                width: 100%;
                height: 6px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 10px;
                margin-top: 15px;
                overflow: hidden;
            }
            body.light-theme .progress-bar-bg {
                background: rgba(0, 0, 0, 0.1);
            }

            .progress-bar-fill {
                height: 100%;
                border-radius: 10px;
                width: 0%;
                background: linear-gradient(90deg, var(--primary), #ff6b8b);
                transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 0 10px var(--primary-glow);
            }
            /* در تم روشن گرادینت قرمز پررنگ */
            body.light-theme .progress-bar-fill {
                background: linear-gradient(90deg, var(--primary), #ef5350);
            }

            /* * ==============================================
         * CONFIG CARDS & DETAILS
         * ==============================================
         */
            .section-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 20px;
                padding-right: 5px;
                margin-top: 8px;
                cursor: pointer;
                user-select: none;
                padding: 10px;
                border-radius: var(--radius-sm);
                transition: background 0.3s;
            }
            .section-header:hover {
                background: rgba(255, 255, 255, 0.05);
            }
            body.light-theme .section-header:hover {
                background: rgba(0, 0, 0, 0.05);
            }

            .section-header h3 {
                margin: 0;
                font-size: 1.1rem;
                flex-shrink: 0;
                color: var(--text-main);
            }
            .section-line {
                height: 3px;
                flex: 1;
                background: linear-gradient(90deg, var(--primary), transparent);
                border-radius: 2px;
            }
            .toggle-icon {
                font-size: 0.8rem;
                color: var(--primary);
                transition: transform 0.3s ease;
                margin-right: 10px;
            }
            .section-header.active .toggle-icon {
                transform: rotate(180deg);
            }

            /* کانتینر لیست کانفیگ‌ها - پیش‌فرض مخفی */
            .config-list {
                display: none;
                animation: slideDown 0.4s ease forwards;
                padding-bottom: 20px;
            }
            .config-list.show {
                display: block;
            }

            .config-card {
                background: rgba(30, 30, 30, 0.4);
                border: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: var(--radius-md);
                padding: 16px;
                margin-bottom: 15px;
                transition: background 0.3s;
                position: relative;
            }
            body.light-theme .config-card {
                background: #fff;
                border-color: rgba(0, 0, 0, 0.08);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            }
            .config-card:hover {
                background: rgba(40, 40, 40, 0.6);
                border-color: var(--primary-glow);
            }
            body.light-theme .config-card:hover {
                background: #fafafa;
                border-color: var(--primary);
            }

            .config-top {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }
            .protocol-badge {
                background: rgba(255, 0, 60, 0.15);
                color: var(--primary);
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 0.75rem;
                font-weight: bold;
                text-transform: uppercase;
                letter-spacing: 1px;
                border: 1px solid rgba(255, 0, 60, 0.2);
            }
            /* اصلاح بج در تم روشن */
            body.light-theme .protocol-badge {
                background: rgba(255, 0, 60, 0.1);
                border-color: rgba(255, 0, 60, 0.2);
            }
            .config-name {
                font-size: 0.9rem;
                font-weight: 600;
                color: #ddd;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
                max-width: 60%;
            }
            body.light-theme .config-name {
                color: #444;
            }

            .config-toolbar {
                display: flex;
                gap: 8px;
                margin-top: 10px;
            }
            .tool-btn {
                flex: 1;
                padding: 8px;
                background: rgba(255, 255, 255, 0.05);
                border: none;
                border-radius: var(--radius-sm);
                color: #ccc;
                font-size: 0.8rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                font-family: var(--font-stack);
                transition: 0.2s;
            }
            body.light-theme .tool-btn {
                background: #f0f0f0;
                color: #555;
            }
            .tool-btn:hover {
                background: rgba(255, 255, 255, 0.12);
                color: #fff;
            }
            body.light-theme .tool-btn:hover {
                background: #e0e0e0;
                color: #000;
            }
            .tool-btn.accent:hover {
                background: var(--primary);
                border-color: var(--primary);
                color: #fff;
            }

            .config-source {
                display: none;
                margin-top: 12px;
                background: #000;
                border: 1px dashed #333;
                border-radius: 8px;
                padding: 10px;
            }
            .config-source.open {
                display: block;
                animation: fadeIn 0.3s;
            }
            body.light-theme .config-source {
                background: #f9f9f9;
                border-color: #ccc;
            }

            .source-text {
                width: 100%;
                background: transparent;
                border: none;
                color: var(--primary);
                font-family: monospace;
                font-size: 0.75rem;
                resize: none;
                height: 60px;
                word-break: break-all;
                direction: ltr;
            }

            /* * ==============================================
         * MODAL & TOAST
         * ==============================================
         */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(5px);
                z-index: 1000;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                visibility: hidden;
                transition: 0.3s;
            }
            .modal-overlay.active {
                opacity: 1;
                visibility: visible;
            }
            .modal-box {
                background: #151515;
                width: 90%;
                max-width: 320px;
                padding: 25px;
                border-radius: 20px;
                border: 1px solid var(--primary);
                text-align: center;
                transform: scale(0.8);
                transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            }
            body.light-theme .modal-box {
                background: #fff;
                border-color: #ddd;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            }
            .modal-overlay.active .modal-box {
                transform: scale(1);
            }

            #qr-placeholder {
                background: #fff;
                padding: 15px;
                border-radius: 12px;
                margin: 15px auto;
                width: fit-content;
                /* رفع باگ QR در زبان‌های RTL و روسی */
                direction: ltr !important;
                text-align: center;
            }
            #qr-placeholder img {
                display: block;
                margin: 0 auto;
            }

            .modal-close {
                background: var(--primary);
                color: #fff;
                border: none;
                width: 100%;
                padding: 12px;
                border-radius: 50px;
                font-weight: bold;
                cursor: pointer;
                font-family: inherit;
            }

            .toast {
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                background: #1f1f1f;
                border: 1px solid var(--primary);
                color: #fff;
                padding: 10px 20px;
                border-radius: 50px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                gap: 8px;
                z-index: 2000;
                transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
                white-space: nowrap;
                font-size: 0.9rem;
            }
            body.light-theme .toast {
                background: #333;
            }
            .toast.show {
                transform: translateX(-50%) translateY(0);
            }

            .manual-fetch-btn {
                display: none;
                width: 100%;
                background: transparent;
                border: 1px dashed #444;
                color: #777;
                padding: 10px;
                border-radius: 8px;
                margin-top: 10px;
                cursor: pointer;
                font-size: 0.8rem;
            }
            .manual-fetch-btn:hover {
                border-color: var(--primary);
                color: var(--primary);
            }

            @keyframes slideDown {
                from {
                    transform: translateY(-30px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .footer {
                margin-top: 50px;
                text-align: center;
                font-size: 0.75rem;
                color: #444;
            }
            .version-tag {
                font-family: monospace;
                opacity: 0.5;
                font-size: 0.7rem;
                margin-top: 5px;
                display: block;
            }
        </style>
    </head>
    <body>
        <div class="bg-fixed"></div>
        <div class="bg-spot spot-1"></div>
        <div class="bg-spot spot-2"></div>

        <div class="main-wrapper">
            <div class="settings-bar">
                <button
                    class="icon-btn"
                    onclick="toggleTheme()"
                    title="Сменить тему"
                >
                    <svg
                        id="theme-icon"
                        style="width: 20px; height: 20px; fill: currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            class="moon"
                            d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"
                        />
                    </svg>
                </button>
                <div class="lang-select-wrapper">
                    <!-- پرچم‌ها حذف شدند -->
                    <select
                        class="lang-select"
                        onchange="changeLanguage(this.value)"
                        id="langSelect"
                    >
                        <option value="fa">فارسی</option>
                        <option value="en">English</option>
                        <option value="ar">العربية</option>
                        <option value="ru">Русский</option>
                    </select>
                </div>
            </div>

            <div class="profile-card">
                <div class="avatar-container">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"
                        />
                    </svg>
                </div>
                <h1 class="username-title">{{ user.username }}</h1>

                {% if user.status == 'active' %}
                <div class="status-chip st-active">
                    <span class="dot"></span
                    ><span data-translate="status_active">Активен</span>
                </div>
                {% elif user.status == 'limited' %}
                <div class="status-chip st-limited">
                    <span class="dot"></span
                    ><span data-translate="status_limited"
                        >Ограничено (трафик/время)</span
                    >
                </div>
                {% elif user.status == 'expired' %}
                <div class="status-chip st-expired">
                    <span class="dot"></span
                    ><span data-translate="status_expired">Просрочено</span>
                </div>
                {% elif user.status == 'disabled' %}
                <div class="status-chip st-disabled">
                    <span class="dot"></span
                    ><span data-translate="status_disabled">Отключено</span>
                </div>
                {% else %}
                <div class="status-chip st-limited">
                    <span class="dot"></span>{{ user.status }}
                </div>
                {% endif %}
            </div>

            <div class="sub-actions">
                <a
                    href="#"
                    id="happ-link"
                    class="btn-main"
                    title="Добавить подписку в приложение happ"
                >
                    <svg class="btn-icon" viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                    </svg>
                    <span data-translate="add_sub">Добавить</span>
                </a>
                <button
                    class="btn-main icon-btn"
                    onclick="copySubscription('{{ subscription_url }}')"
                    title="Скопировать ссылку подписки"
                >
                    <svg class="btn-icon" viewBox="0 0 24 24">
                        <path
                            d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"
                        />
                    </svg>
                </button>
                <button
                    class="btn-main icon-btn"
                    onclick="openQR('{{ subscription_url }}', 'Ссылка подписки')"
                    title="QR подписки"
                >
                    <svg class="btn-icon" viewBox="0 0 24 24">
                        <path
                            d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"
                        />
                    </svg>
                </button>
            </div>

            <!-- Download Section - moved above add button -->
            <div class="platform-selector-box">
                <div class="platform-selector-header">
                    <div class="section-header" onclick="toggleDownloads(this)">
                        <h3 data-translate="download_apps">
                            Скачать приложения
                        </h3>
                        <div class="section-line"></div>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="platform-dropdown-wrapper">
                        <button
                            class="platform-dropdown-btn"
                            onclick="
                                togglePlatformMenu();
                                event.stopPropagation();
                            "
                        >
                            <span id="currentPlatformName">iOS</span>
                            <svg
                                style="width: 14px; height: 14px"
                                viewBox="0 0 24 24"
                            >
                                <path d="M7 10l5 5 5-5z" fill="currentColor" />
                            </svg>
                        </button>
                        <div
                            class="platform-dropdown-menu"
                            id="platformDropdownMenu"
                        >
                            <button
                                class="platform-option"
                                onclick="switchPlatform('ios', 'iOS')"
                            >
                                iOS
                            </button>
                            <button
                                class="platform-option"
                                onclick="switchPlatform('android', 'Android')"
                            >
                                Android
                            </button>
                            <button
                                class="platform-option"
                                onclick="switchPlatform('windows', 'Windows')"
                            >
                                Windows
                            </button>
                            <button
                                class="platform-option"
                                onclick="switchPlatform('macos', 'macOS')"
                            >
                                macOS
                            </button>
                        </div>
                    </div>
                </div>
                <div class="config-list" id="downloadContainer">
                    <div class="platform-selector-container">
                        <div class="instruction-buttons">
                            <div class="platform-buttons" id="happ-ios-buttons">
                                <a
                                    href="https://apps.apple.com/ru/app/happ-proxy-utility-plus/id6746188973"
                                    class="app-download-btn"
                                    target="_blank"
                                    >App Store (RU)</a
                                >
                                <a
                                    href="https://apps.apple.com/us/app/happ-proxy-utility/id6504287215"
                                    class="app-download-btn"
                                    target="_blank"
                                    >App Store (Global)</a
                                >
                            </div>
                            <div
                                class="platform-buttons"
                                id="happ-android-buttons"
                                style="display: none"
                            >
                                <a
                                    href="https://play.google.com/store/apps/details?id=com.happproxy"
                                    class="app-download-btn"
                                    target="_blank"
                                    >Google Play</a
                                >
                                <a
                                    href="https://github.com/Happ-proxy/happ-android/releases/latest/download/Happ.apk"
                                    class="app-download-btn"
                                    target="_blank"
                                    >Прямая загрузка APK</a
                                >
                            </div>
                            <div
                                class="platform-buttons"
                                id="happ-windows-buttons"
                                style="display: none"
                            >
                                <a
                                    href="https://github.com/Happ-proxy/happ-desktop/releases/latest/download/setup-Happ.x64.exe"
                                    class="app-download-btn"
                                    target="_blank"
                                    >Скачать для Windows</a
                                >
                            </div>
                            <div
                                class="platform-buttons"
                                id="happ-macos-buttons"
                                style="display: none"
                            >
                                <a
                                    href="https://apps.apple.com/ru/app/happ-proxy-utility-plus/id6746188973"
                                    class="app-download-btn"
                                    target="_blank"
                                    >App Store (RU)</a
                                >
                                <a
                                    href="https://apps.apple.com/us/app/happ-proxy-utility/id6504287215"
                                    class="app-download-btn"
                                    target="_blank"
                                    >App Store (Global)</a
                                >
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div
                    class="stat-box"
                    style="animation: fadeInUp 0.5s ease backwards"
                >
                    <svg
                        style="
                            width: 24px;
                            height: 24px;
                            fill: var(--primary);
                            margin-bottom: 5px;
                        "
                        viewBox="0 0 24 24"
                    >
                        <path
                            d="M7.77 6.76L6.23 5.48.82 12l5.41 6.52 1.54-1.28L3.42 12l4.35-5.24zM7 13h2v-2H7v2zm10-2h-2v2h2v-2zm-6 2h2v-2h-2v2zm6.77-7.52l-1.54 1.28L20.58 12l-4.35 5.24 1.54 1.28L23.18 12l-5.41-6.52z"
                        />
                    </svg>
                    <div class="stat-number" dir="ltr">
                        {{ user.used_traffic | bytesformat }}
                    </div>
                    <div class="stat-desc">
                        <span data-translate="usage_label">Использовано</span>
                        {{ user.data_limit | bytesformat if user.data_limit else
                        'Неограниченно' }}
                    </div>
                    {% if user.data_limit %} {% set usage_p = (user.used_traffic
                    / user.data_limit * 100) | round(2) %}
                    <div class="progress-bar-bg">
                        <div
                            class="progress-bar-fill"
                            style="width: {{ usage_p }}%"
                        ></div>
                    </div>
                    {% else %}
                    <div class="progress-bar-bg">
                        <div
                            class="progress-bar-fill"
                            style="width: 100%; background: #333"
                        ></div>
                    </div>
                    {% endif %}
                </div>

                <div
                    class="stat-box"
                    style="animation: fadeInUp 0.5s ease 0.1s backwards"
                >
                    <svg
                        style="
                            width: 24px;
                            height: 24px;
                            fill: var(--primary);
                            margin-bottom: 5px;
                        "
                        viewBox="0 0 24 24"
                    >
                        <path
                            d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"
                        />
                    </svg>
                    {% if user.expire %} {% set days = ((user.expire -
                    now()).total_seconds() / 86400) | int %}
                    <div class="stat-number">{{ days }}</div>
                    <div class="stat-desc" data-translate="days_left">
                        Осталось дней
                    </div>
                    <div class="progress-bar-bg">
                        <div
                            class="progress-bar-fill"
                            style="width: 100%; filter: hue-rotate(40deg)"
                        ></div>
                    </div>
                    {% else %}
                    <div class="stat-number">∞</div>
                    <div class="stat-desc" data-translate="time_unlimited">
                        Без ограничения по времени
                    </div>
                    <div class="progress-bar-bg">
                        <div
                            class="progress-bar-fill"
                            style="width: 100%; background: #00ff88"
                        ></div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="section-header" onclick="toggleConfigs(this)">
                <h3 data-translate="your_connections">Ваши подключения</h3>
                <div class="section-line"></div>
                <span class="toggle-icon">▼</span>
            </div>

            <div class="config-list" id="configContainer">
                <!-- ADDED: Copy All Configs Button -->
                <button
                    class="btn-main"
                    style="
                        width: 100%;
                        margin-bottom: 15px;
                        background: rgba(0, 255, 136, 0.1);
                        border-color: rgba(0, 255, 136, 0.4);
                    "
                    onclick="copyAllConfigs()"
                >
                    <svg class="btn-icon" viewBox="0 0 24 24">
                        <path
                            d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"
                        />
                    </svg>
                    <span data-translate="copy_all"
                        >Копировать все конфигурации</span
                    >
                </button>

                {% for link in links %} {% set protocol = link.split('://')[0]
                %}
                <div
                    class="config-card server-item"
                    style="animation: fadeInUp 0.5s ease {{ loop.index0 * 0.1 }}s backwards;"
                >
                    <div class="config-top">
                        <span class="protocol-badge">{{ protocol }}</span>
                        <span class="config-name" dir="auto">
                            {% if '#' in link %} {{ link.split('#')[-1] }} {%
                            else %} Config #{{ loop.index }} {% endif %}
                        </span>
                    </div>
                    <div class="config-toolbar">
                        <button
                            class="tool-btn accent"
                            onclick="copyText('{{ link }}')"
                        >
                            <svg
                                style="width: 16px; height: 16px"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    fill="currentColor"
                                    d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"
                                />
                            </svg>
                            <span data-translate="btn_copy">Копировать</span>
                        </button>
                        <button
                            class="tool-btn"
                            onclick="openQR('{{ link }}', 'Config #{{ loop.index }}')"
                        >
                            <svg
                                style="width: 16px; height: 16px"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    fill="currentColor"
                                    d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"
                                />
                            </svg>
                            QR
                        </button>
                        <button class="tool-btn" onclick="toggleSource(this)">
                            <svg
                                style="width: 16px; height: 16px"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    fill="currentColor"
                                    d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"
                                />
                            </svg>
                            <span data-translate="btn_view">Просмотр</span>
                        </button>
                    </div>
                    <div class="config-source">
                        <textarea
                            class="source-text"
                            readonly
                            onclick="this.select()"
                        >
{{ link }}</textarea
                        >
                        <div
                            style="
                                font-size: 0.7rem;
                                color: #666;
                                margin-top: 4px;
                            "
                            data-translate="manual_copy_hint"
                        >
                            Чтобы скопировать вручную, нажмите на текст
                        </div>
                    </div>
                </div>
                {% endfor %}

                <div
                    id="loading-msg"
                    style="
                        display: none;
                        text-align: center;
                        padding: 10px;
                        color: #666;
                        font-size: 0.8rem;
                    "
                    data-translate="loading"
                >
                    Загрузка данных...
                </div>
                <div
                    id="error-msg"
                    style="
                        display: none;
                        text-align: center;
                        padding: 10px;
                        color: #ff003c;
                        font-size: 0.8rem;
                    "
                ></div>
                <button
                    id="retry-btn"
                    class="manual-fetch-btn"
                    onclick="checkAndLoadConfigs(true)"
                    data-translate="retry"
                >
                    Повторная попытка загрузки конфигураций
                </button>
            </div>
        </div>

        <div class="modal-overlay" id="qrModal" onclick="closeQR(event)">
            <div class="modal-box" onclick="event.stopPropagation()">
                <h3 id="qrTitle" style="margin-top: 0; color: var(--text-main)">
                    QR Code
                </h3>
                <div id="qr-placeholder"></div>
                <button
                    class="modal-close"
                    onclick="closeQR()"
                    data-translate="btn_close"
                >
                    Закрыть
                </button>
            </div>
        </div>

        <div class="toast" id="toast">
            <svg
                style="width: 20px; height: 20px; color: var(--status-active)"
                viewBox="0 0 24 24"
            >
                <path
                    fill="currentColor"
                    d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"
                />
            </svg>
            <span data-translate="toast_copied">Скопировано!</span>
        </div>

        <script>
            // ==========================================
            //  FIXED LOGIC FOR COPY & QR & UX
            // ==========================================
            function copySubscription(tmplLink) {
                let finalLink = tmplLink;
                if (!finalLink || finalLink.trim() === "") {
                    finalLink = window.location.href;
                }
                copyText(finalLink);
            }

            document.addEventListener("DOMContentLoaded", function () {
                // 1. Находим нашу кнопку
                const linkElement = document.getElementById("happ-link");

                if (linkElement) {
                    // 2. Берем текущий URL страницы
                    const currentUrl = window.location.href;

                    // 3. Формируем новую ссылку
                    const finalLink = "happ://add/" + currentUrl;

                    // 4. Записываем её прямо в атрибут href кнопки
                    linkElement.setAttribute("href", finalLink);
                }
            });

            function copyText(text) {
                if (!text) return;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard
                        .writeText(text)
                        .then(showToast)
                        .catch(() => fallbackCopy(text));
                } else {
                    fallbackCopy(text);
                }
            }

            // ADDED: Logic to copy all configs
            function copyAllConfigs() {
                const container = document.getElementById("configContainer");
                const sourceTexts = container.querySelectorAll(".source-text");
                if (sourceTexts.length === 0) {
                    alert("Конфигурация для копирования не найдена!");
                    return;
                }
                let allConfigs = "";
                sourceTexts.forEach((txt) => {
                    if (txt.value && txt.value.trim() !== "") {
                        allConfigs += txt.value.trim() + "\n";
                    }
                });
                if (allConfigs.trim() === "") {
                    alert("Конфигурация для копирования не найдена!");
                    return;
                }
                copyText(allConfigs);
            }

            // ADDED: Logic to toggle downloads section
            function toggleDownloads(header) {
                const list = document.getElementById("downloadContainer");
                if (list.classList.contains("show")) {
                    list.classList.remove("show");
                    header.classList.remove("active");
                } else {
                    list.classList.add("show");
                    header.classList.add("active");
                }
            }

            function fallbackCopy(text) {
                try {
                    const tempInput = document.createElement("textarea");
                    tempInput.value = text;
                    tempInput.style.position = "fixed";
                    tempInput.style.left = "-9999px";
                    tempInput.style.top = "0";
                    document.body.appendChild(tempInput);
                    tempInput.focus();
                    tempInput.select();
                    const success = document.execCommand("copy");
                    document.body.removeChild(tempInput);
                    if (success) showToast();
                    else
                        alert(
                            "Ошибка при копировании! Пожалуйста, скопируйте вручную.",
                        );
                } catch (e) {
                    console.error(e);
                    alert(
                        "Ваш браузер не позволяет автоматическое копирование.",
                    );
                }
            }

            function showToast() {
                const toast = document.getElementById("toast");
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 2000);
            }

            let qrObj = null;
            function openQR(text, title) {
                let content = text;
                const currentLang = localStorage.getItem("user_lang") || "ru";
                // ترجمه داینامیک تایتل QR
                if (title === "لینک اشتراک") {
                    const titles = {
                        fa: "لینک اشتراک",
                        en: "Subscription Link",
                        ar: "رابط الاشتراك",
                        ru: "Ссылка подписки",
                    };
                    title = titles[currentLang] || title;
                }
                if (
                    (!content || content.trim() === "") &&
                    (title === "لینک اشتراک" ||
                        title === "Subscription Link" ||
                        title === "رابط الاشتراك" ||
                        title === "Ссылка подписки")
                ) {
                    content = window.location.href;
                }

                const modal = document.getElementById("qrModal");
                const container = document.getElementById("qr-placeholder");
                const titleEl = document.getElementById("qrTitle");

                try {
                    title = decodeURIComponent(title);
                } catch (e) {}
                titleEl.textContent = title;

                // پاکسازی QR قبلی
                container.innerHTML = "";
                try {
                    // رفع باگ QR: اطمینان از پاک شدن و ساخت مجدد صحیح
                    qrObj = new QRCode(container, {
                        text: content,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.L, // سطح L برای دیتای زیاد بهتر جواب می‌دهد
                    });
                    modal.classList.add("active");
                } catch (e) {
                    console.error("QR Error:", e);
                    container.innerHTML =
                        '<p style="color:red; direction:ltr">QR Generation Error</p>';
                    modal.classList.add("active");
                }
            }

            function closeQR(e) {
                document.getElementById("qrModal").classList.remove("active");
            }

            function toggleSource(btn) {
                const card = btn.closest(".config-card");
                const sourceBox = card.querySelector(".config-source");
                if (sourceBox.classList.contains("open")) {
                    sourceBox.classList.remove("open");
                    btn.style.background = "";
                    btn.style.color = "";
                } else {
                    sourceBox.classList.add("open");
                    btn.style.background = "var(--primary)";
                    btn.style.color = "#fff";
                }
            }

            function toggleConfigs(header) {
                const list = document.getElementById("configContainer");
                if (list.classList.contains("show")) {
                    list.classList.remove("show");
                    header.classList.remove("active");
                } else {
                    list.classList.add("show");
                    header.classList.add("active");
                    setTimeout(() => {
                        checkAndLoadConfigs();
                    }, 100);
                }
            }

            // ==========================================
            //  ADVANCED CONFIG FETCHING
            // ==========================================
            let configsLoaded = false;
            function checkAndLoadConfigs(forceRetry = false) {
                const container = document.getElementById("configContainer");
                // Modified: Check if .server-item exists OR if we already loaded clients.
                if (container.querySelector(".server-item") && !forceRetry)
                    return;
                if (configsLoaded && !forceRetry) return;

                let subUrl = "{{ subscription_url }}";
                if (subUrl && !subUrl.startsWith("http")) {
                    subUrl = window.location.origin + subUrl;
                }
                if (!subUrl) subUrl = window.location.href;

                const loadingMsg = document.getElementById("loading-msg");
                const errorMsg = document.getElementById("error-msg");
                const retryBtn = document.getElementById("retry-btn");

                loadingMsg.style.display = "block";
                errorMsg.style.display = "none";
                retryBtn.style.display = "none";

                fetch(subUrl, { cache: "no-store" })
                    .then((res) => {
                        if (!res.ok) throw new Error("HTTP " + res.status);
                        return res.text();
                    })
                    .then((text) => {
                        if (!text) throw new Error("Empty response");
                        let decoded = "";
                        try {
                            const cleanText = text.replace(/\s/g, "");
                            decoded = atob(cleanText);
                        } catch (e) {
                            decoded = text;
                        }
                        const lines = decoded
                            .split(/\r?\n/)
                            .filter((line) => line.trim().length > 5);
                        if (lines.length === 0)
                            throw new Error("No configs found");

                        renderClientConfigs(lines);
                        configsLoaded = true;
                        loadingMsg.style.display = "none";
                    })
                    .catch((err) => {
                        console.error("Fetch error:", err);
                        loadingMsg.style.display = "none";
                        errorMsg.style.display = "block";
                        errorMsg.textContent =
                            "Не удалось получить конфигурации. (CORS или ошибка сети)";
                        retryBtn.style.display = "block";
                    });
            }

            function renderClientConfigs(links) {
                const container = document.getElementById("configContainer");
                const oldItems = container.querySelectorAll(".client-item");
                oldItems.forEach((el) => el.remove());

                // Notice: The "Copy All" button remains because it's static HTML at the top.

                links.forEach((link, index) => {
                    let protocol = "UNKNOWN";
                    if (link.startsWith("vmess://")) protocol = "VMESS";
                    else if (link.startsWith("vless://")) protocol = "VLESS";
                    else if (link.startsWith("trojan://")) protocol = "TROJAN";
                    else if (link.startsWith("ss://")) protocol = "SHADOWSOCKS";
                    else if (link.startsWith("tuic://")) protocol = "TUIC";
                    else if (
                        link.startsWith("hy2://") ||
                        link.startsWith("hysteria2://")
                    )
                        protocol = "HYSTERIA2";

                    let configName = `Config #${index + 1}`;
                    if (link.includes("#")) {
                        try {
                            configName = decodeURIComponent(
                                link.split("#").pop(),
                            );
                        } catch (e) {
                            configName = link.split("#").pop();
                        }
                    }

                    const lang = localStorage.getItem("user_lang") || "ru";
                    const t = translations[lang];

                    const card = document.createElement("div");
                    card.className = "config-card client-item";
                    card.style.animation = `fadeInUp 0.5s ease ${index * 0.1}s backwards`;

                    // Escaping single quotes for JS function calls
                    const safeLink = link.replace(/'/g, "\\'");
                    const safeName = configName.replace(/'/g, "\\'");

                    card.innerHTML = `
                    <div class="config-top">
                        <span class="protocol-badge">${protocol}</span>
                        <span class="config-name" dir="auto">${configName}</span>
                    </div>
                    <div class="config-toolbar">
                        <button class="tool-btn accent" onclick="copyText('${safeLink}')">
                            <svg style="width:16px;height:16px;" viewBox="0 0 24 24"><path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                            ${t.btn_copy}
                        </button>
                        <button class="tool-btn" onclick="openQR('${safeLink}', '${safeName}')">
                            <svg style="width:16px;height:16px;" viewBox="0 0 24 24"><path fill="currentColor" d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"/></svg>
                            QR
                        </button>
                        <button class="tool-btn" onclick="toggleSource(this)">
                            <svg style="width:16px;height:16px;" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                            ${t.btn_view}
                        </button>
                    </div>
                    <div class="config-source">
                        <textarea class="source-text" readonly onclick="this.select()">${link}</textarea>
                        <div style="font-size:0.7rem; color:#666; margin-top:4px;">${t.manual_copy_hint}</div>
                    </div>
                `;
                    container.appendChild(card);
                });
            }

            window.addEventListener("load", () => {
                const fills = document.querySelectorAll(".progress-bar-fill");
                fills.forEach((f) => {
                    const w = f.style.width;
                    f.style.width = "0%";
                    setTimeout(() => (f.style.width = w), 300);
                });
                document
                    .querySelectorAll(".server-item .config-name")
                    .forEach((el) => {
                        try {
                            if (el.textContent.includes("%")) {
                                el.textContent = decodeURIComponent(
                                    el.textContent,
                                );
                            }
                        } catch (e) {}
                    });
                initPreferences();
            });

            // ==========================================
            //  NEW: MULTI-LANGUAGE & THEME LOGIC
            // ==========================================
            const translations = {
                fa: {
                    page_title: "پنل کاربری",
                    status_active: "فعال",
                    status_limited: "محدود شده (حجم/زمان)",
                    status_expired: "منقضی شده",
                    status_disabled: "غیرفعال شده",
                    copy_sub: "کپی لینک اشتراک",
                    qr_sub: "QR اشتراک",
                    usage_label: "مصرف از",
                    days_left: "روز باقی‌مانده",
                    time_unlimited: "زمان نامحدود",
                    your_connections: "کانکشن‌های شما",
                    download_apps: "دانلود برنامه‌ها",
                    copy_all: "کپی همه کانفیگ‌ها",
                    android_app: "اندروید (v2rayNG)",
                    ios_app: "آیفون (V2Box)",
                    windows_app: "ویندوز (v2rayN)",
                    linux_app: "لینوکس (Nekoray)",
                    btn_copy: "کپی",
                    btn_view: "مشاهده",
                    btn_close: "بستن",
                    toast_copied: "کپی شد!",
                    manual_copy_hint: "برای کپی دستی روی متن کلیک کنید",
                    loading: "در حال دریافت اطلاعات...",
                    retry: "تلاش مجدد",
                    dir: "rtl",
                },
                en: {
                    page_title: "User Panel",
                    status_active: "Active",
                    status_limited: "Limited (Data/Time)",
                    status_expired: "Expired",
                    status_disabled: "Disabled",
                    copy_sub: "Copy Link",
                    qr_sub: "QR Code",
                    usage_label: "Used from",
                    days_left: "Days remaining",
                    time_unlimited: "Unlimited Time",
                    your_connections: "Connections",
                    download_apps: "Download Apps",
                    copy_all: "Copy All Configs",
                    android_app: "Android (v2rayNG)",
                    ios_app: "iOS (V2Box)",
                    windows_app: "Windows (v2rayN)",
                    linux_app: "Linux (Nekoray)",
                    btn_copy: "Copy",
                    btn_view: "View",
                    btn_close: "Close",
                    toast_copied: "Copied!",
                    manual_copy_hint: "Click text to copy manually",
                    loading: "Loading data...",
                    retry: "Retry",
                    dir: "ltr",
                },
                ar: {
                    page_title: "لوحة المستخدم",
                    status_active: "نشط",
                    status_limited: "محدود (البيانات/الوقت)",
                    status_expired: "منتهية الصلاحية",
                    status_disabled: "معطل",
                    copy_sub: "نسخ الرابط",
                    qr_sub: "رمز QR",
                    usage_label: "مستهلك من",
                    days_left: "أيام متبقية",
                    time_unlimited: "وقت غير محدود",
                    your_connections: "اتصالاتك",
                    download_apps: "تنزيل التطبيقات",
                    copy_all: "نسخ جميع التكوينات",
                    android_app: "أندرويد (v2rayNG)",
                    ios_app: "آيفون (V2Box)",
                    windows_app: "ويندوز (v2rayN)",
                    linux_app: "لينكس (Nekoray)",
                    btn_copy: "نسخ",
                    btn_view: "عرض",
                    btn_close: "إغلاق",
                    toast_copied: "تم النسخ!",
                    manual_copy_hint: "انقر فوق النص للنسخ يدوياً",
                    loading: "جار تحميل البيانات...",
                    retry: "أعد المحاولة",
                    dir: "rtl",
                },
                ru: {
                    page_title: "Панель пользователя",
                    status_active: "Активный",
                    status_limited: "Ограничено",
                    status_expired: "Истекший",
                    status_disabled: "Отключено",
                    copy_sub: "Копировать",
                    qr_sub: "QR-код",
                    usage_label: "Использовано из",
                    days_left: "Дней осталось",
                    time_unlimited: "Безлимит",
                    your_connections: "Подключения",
                    download_apps: "Скачать приложения",
                    copy_all: "Копировать все",
                    android_app: "Android (v2rayNG)",
                    ios_app: "iOS (V2Box)",
                    windows_app: "Windows (v2rayN)",
                    linux_app: "Linux (Nekoray)",
                    btn_copy: "Копия",
                    btn_view: "Вид",
                    btn_close: "Закрыть",
                    toast_copied: "Скопировано!",
                    manual_copy_hint: "Нажмите текст для копирования",
                    loading: "Загрузка...",
                    retry: "Повторить",
                    dir: "ltr",
                },
            };

            function initPreferences() {
                // Theme Init
                const savedTheme = localStorage.getItem("user_theme");
                if (savedTheme === "light") {
                    document.body.classList.add("light-theme");
                    updateThemeIcon(true);
                }
                // Lang Init
                const savedLang = localStorage.getItem("user_lang") || "ru";
                document.getElementById("langSelect").value = savedLang;
                changeLanguage(savedLang);
            }

            function toggleTheme() {
                const isLight = document.body.classList.toggle("light-theme");
                localStorage.setItem("user_theme", isLight ? "light" : "dark");
                updateThemeIcon(isLight);
            }

            function updateThemeIcon(isLight) {
                const icon = document.getElementById("theme-icon");
                if (isLight) {
                    // Sun Icon
                    icon.innerHTML =
                        '<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 0 0-1.41 0 .996.996 0 0 0 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 0 0-1.41 0 .996.996 0 0 0 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 0 0 0-1.41.996.996 0 0 0-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 0 0 0 1.41.996.996 0 0 0 1.41 0l1.06-1.06c.39-.39.39-1.03 0-1.41s-1.03-.39-1.41 0l-1.06 1.06z"/>';
                } else {
                    // Moon Icon
                    icon.innerHTML =
                        '<path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>';
                }
            }

            function changeLanguage(lang) {
                localStorage.setItem("user_lang", lang);
                const t = translations[lang];
                document.documentElement.setAttribute("dir", t.dir);
                document.body.className = document.body.className.replace(
                    /lang-\w+/g,
                    "",
                );
                document.body.classList.add("lang-" + lang);

                document.querySelectorAll("[data-translate]").forEach((el) => {
                    const key = el.getAttribute("data-translate");
                    if (t[key]) el.textContent = t[key];
                });

                const titleEl = document.querySelector("title");
                if (titleEl && titleEl.textContent.includes("|")) {
                    const username = titleEl.textContent.split("|")[1];
                    titleEl.textContent = t.page_title + " | " + username;
                }
            }

            // Detect platform and show appropriate download buttons
            function initPlatformButtons() {
                const userAgent = navigator.userAgent.toLowerCase();
                let platform = "ios"; // default to iOS

                if (/android/.test(userAgent)) {
                    platform = "android";
                } else if (/windows/.test(userAgent)) {
                    platform = "windows";
                } else if (/macintosh|macos/.test(userAgent)) {
                    platform = "macos";
                } else if (/iphone|ipad|ipod/.test(userAgent)) {
                    platform = "ios";
                }

                showPlatform(platform);
            }

            // Switch platform and show corresponding buttons
            function switchPlatform(platform, platformName) {
                localStorage.setItem("selectedPlatform", platform);
                showPlatform(platform);
                document.getElementById("currentPlatformName").textContent =
                    platformName;
                closePlatformMenu();
            }

            // Show platform buttons and update button label
            function showPlatform(platform) {
                // Update button text
                const platformNames = {
                    ios: "iOS",
                    android: "Android",
                    windows: "Windows",
                    macos: "macOS",
                };
                document.getElementById("currentPlatformName").textContent =
                    platformNames[platform] || "iOS";

                // Hide all platform buttons
                document.getElementById("happ-ios-buttons").style.display =
                    "none";
                document.getElementById("happ-android-buttons").style.display =
                    "none";
                document.getElementById("happ-windows-buttons").style.display =
                    "none";
                document.getElementById("happ-macos-buttons").style.display =
                    "none";

                // Show the selected platform buttons
                const platformId = "happ-" + platform + "-buttons";
                const element = document.getElementById(platformId);
                if (element) {
                    element.style.display = "grid";
                }
            }

            // Toggle platform dropdown menu
            function togglePlatformMenu() {
                const menu = document.getElementById("platformDropdownMenu");
                menu.classList.toggle("show");
            }

            // Close platform dropdown menu
            function closePlatformMenu() {
                const menu = document.getElementById("platformDropdownMenu");
                menu.classList.remove("show");
            }

            // Close menu when clicking outside
            document.addEventListener("click", function (event) {
                const wrapper = document.querySelector(
                    ".platform-dropdown-wrapper",
                );
                if (wrapper && !wrapper.contains(event.target)) {
                    closePlatformMenu();
                }
            });

            // Initialize platform buttons on page load
            if (document.readyState === "loading") {
                document.addEventListener(
                    "DOMContentLoaded",
                    initPlatformButtons,
                );
            } else {
                initPlatformButtons();
            }
        </script>
    </body>
</html>
